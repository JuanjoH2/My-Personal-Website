---
import BaseLayout from "../layouts/BaseLayout.astro";
import Music1 from "../assets/music1.svg";
import Music2 from "../assets/music2.svg";
import Music3 from "../assets/music3.svg";
import Music4 from "../assets/music4.svg";
import "../styles/global.css";
const pageTitle = "Home Page";
---

<BaseLayout pageTitle={pageTitle}>
    <section id="compositions">
        <div id="compositionsDiv" class="subtitleDiv">
            <h2>Musical Compositions</h2>
            <button onclick="window.location.href='/music'"> </button>
        </div>
        <Music1 class="music-icon" />
        <Music2 class="music-icon" />
        <Music3 class="music-icon" />
        <Music4 class="music-icon" />
        <Music1 class="music-icon" />
        <Music2 class="music-icon" />
        <Music3 class="music-icon" />
        <Music4 class="music-icon" />
        <Music1 class="music-icon" />
        <Music2 class="music-icon" />
        <Music3 class="music-icon" />
    </section>

    <section id="thoughts">
        <div class="text-container" id="thoughts-text-box">
            <div class="subtitleDiv" id="thoughtsDiv">
                <h2>Thoughts</h2>
                <button onclick="window.location.href='/thoughts'"> </button>
            </div>
            <p class="typing-text" id="typewriter-text">
                <span id="cursor"></span>
            </p>
        </div>
    </section>

    <section id="newsletter">
        <div class="subtitleDiv">
            <h2>Newsletter</h2>
            <button onclick="window.location.href='/newsletter'"> </button>
        </div>
    </section>
    <section id="code">
        <div class="subtitleDiv">
            <h2>Code projects_</h2>
            <button onclick="window.location.href='/code'"> </button>
        </div>
    </section>
</BaseLayout>

<script>
    // ðŸ’¡ The complete text to be typed out (same as before)
    const fullText =
        "Weâ€™ve all been there. We set a goal for ourselves, we get excited, we create a strategy (sometimes), and we start doing it. But a few weeks pass by, and life happens. We donâ€™t achieve it, and disappointment kicks-in. Does this sound familiar? Apparently this is the story thatWeâ€™ve all been there. We set a goal for ourselves, we get excited, we create a strategy (sometimes), and we start doing it.";

    const textElement = document.getElementById(
        "typewriter-text",
    ) as HTMLParagraphElement;
    const cursorElement = document.getElementById("cursor") as HTMLSpanElement;
    const hoverDiv = document.getElementById("thoughtsDiv") as HTMLElement;

    let typingInterval: number | undefined = undefined;
    // ðŸ’¡ FIX 1: Use a managed index to track the current position
    let index: number = 0;

    // Helper function to get the current visible text length (still useful for 'index' update)
    function getCurrentTextLength() {
        const textNodes = Array.from(textElement.childNodes).filter(
            (node): node is Text => node.nodeType === Node.TEXT_NODE,
        );
        // Concatenate all text nodes and get the length. Default to 0 if none.
        return textNodes.map((node) => node.textContent || "").join("").length;
    }

    // Function to handle adding characters one by one
    function typeCharacter() {
        // ðŸ’¡ FIX 2: Use the global index, not calculated length
        if (index < fullText.length) {
            const nextChar = fullText[index];

            textElement.insertBefore(
                document.createTextNode(nextChar),
                cursorElement,
            );
            // ðŸ’¡ Increment the index for the next character
            index++;
        } else {
            // Text is fully typed, stop the interval
            if (typeof typingInterval === "number") {
                clearInterval(typingInterval);
                typingInterval = undefined;
            }
        }
    }

    // Function called on mouseenter
    function startTyping() {
        // 1. Clear any active interval (either typing or deleting)
        if (typeof typingInterval === "number") clearInterval(typingInterval);

        // 2. Ensure cursor is visible
        cursorElement.style.display = "inline-block";

        // 3. Move the cursor to the end of the existing text.
        textElement.appendChild(cursorElement);

        // ðŸ’¡ REMOVED: Manual insertion of fullText[0] is removed,
        // as the index is now guaranteed to be 0 on first run.

        // 4. Start typing (it will resume from the current index)
        typingInterval = setInterval(typeCharacter, 15) as unknown as number;
    }

    // Function called on mouseleave
    function startDeleting() {
        // 1. Clear any active interval (either typing or deleting)
        if (typeof typingInterval === "number") clearInterval(typingInterval);

        typingInterval = setInterval(() => {
            const textNodes = Array.from(textElement.childNodes).filter(
                (node): node is Text => node.nodeType === Node.TEXT_NODE,
            );

            if (textNodes.length > 0) {
                const lastTextNode = textNodes[textNodes.length - 1];

                let content = lastTextNode.textContent;

                if (content) {
                    // Move the cursor to the correct deletion point
                    textElement.insertBefore(
                        cursorElement,
                        lastTextNode.nextSibling,
                    );

                    if (content.length > 1) {
                        lastTextNode.textContent = content.slice(0, -1);
                        // ðŸ’¡ DECREMENT INDEX: We delete one character
                        index--;
                    } else if (content.length === 1) {
                        textElement.removeChild(lastTextNode);
                        // ðŸ’¡ DECREMENT INDEX: We delete one character
                        index--;
                    }
                }
            } else {
                // Text is fully deleted, stop the interval and hide the cursor
                if (typeof typingInterval === "number")
                    clearInterval(typingInterval);
                typingInterval = undefined;
                cursorElement.style.display = "none";
                // ðŸ’¡ Reset index to 0 when deletion is complete
                index = 0;
            }
        }, 20) as unknown as number;
    }

    // Attach event listeners to the thoughtsDiv
    hoverDiv.addEventListener("mouseenter", startTyping);
    hoverDiv.addEventListener("mouseleave", startDeleting);
</script>

<style>
    /*
    * MUSICAL COMPOSITIONS SECTION (No changes)
    */
    .music-icon {
        /* Set the starting position */
        translate: -50% -50%;
        position: absolute;
        z-index: -1;
        left: 50%;
        top: 50%;

        /* Set size and color */
        width: 64px;
        height: 64px;
        color: white;

        /* Set the animation */
        transition: transform 1s ease-out;
    }

    /* 1. Left and Up */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(2) {
        /* Moves 200px Left (Negative X) and 150px Up (Negative Y) from the center */
        transform: translate(-250px, -200px);
        transition-delay: 0.1s;
        color: #0091e1;
        /* Set size and color */
        width: 32px;
        height: 32px;
    }

    /* 2. Far Right */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(3) {
        /* Moves 350px Right (Positive X) and 20px Up (Negative Y) from the center */
        transform: translate(350px, -20px);
        transition-delay: 0.2s;
        /* Set size and color */
        width: 32px;
        height: 32px;
    }

    /* 3. Down and Left (Opposite of 1) */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(4) {
        /* Moves 100px Left and 250px Down (Positive Y) from the center */
        transform: translate(-100px, 200px);
        transition-delay: 0.3s;
        color: #0091e1;
        /* Set size and color */
        width: 32px;
        height: 32px;
    }

    /* 4. Far Up */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(5) {
        /* Moves 50px Left and 300px Up from the center */
        transform: translate(-50px, -300px);
        transition-delay: 0.4s;
    }

    /* 5. Down and left */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(6) {
        /* Moves 150px Right and 100px Down from the center */
        transform: translate(-300px, 250px);
        transition-delay: 0.5s;
    }

    /* 6. Up, slightly centered */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(7) {
        /* Moves 20px Right and 150px Up from the center */
        transform: translate(50px, -200px);
        transition-delay: 0.6s;
    }

    /* 7. Far Down */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(8) {
        /* Moves 100px Right and 350px Down from the center */
        transform: translate(100px, 300px);
        transition-delay: 0.7s;
        color: #0091e1;
    }

    /* 8. Just outside the left border */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(9) {
        /* Moves 300px Left and 50px Down from the center */
        transform: translate(-350px, 50px);
        transition-delay: 0.8s;
    }

    /* 9. Down and Right */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(10) {
        /* Moves 250px Right and 250px Down from the center */
        transform: translate(250px, 200px);
        transition-delay: 0.9s;
        /* Set size and color */
        width: 128px;
        height: 128px;
    }

    /* 10. Up and Right */
    #compositionsDiv:hover ~ .music-icon:nth-of-type(11) {
        /* Moves 500px Right (Positive X) and 500px Up (Negative Y) from the center */
        transform: translate(300px, -300px);
        transition-delay: 1s;
        color: #0091e1;
    }

    /*
    * THOUGHTS SECTION
    */

    #thoughtsDiv {
        position: absolute;

        z-index: 10;
    }

    /* The text-container is the viewport/bounding box */
    .text-container {
        position: relative;
        /* Set the desired height for the entire thoughts box */
        height: 478px;
        width: 768px;
        /* Crucially, permanently clip any content that goes beyond this height */
        overflow: hidden;

        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
    }

    /* 2. Text Element Styling */
    .typing-text {
        /* Position the text element */
        position: absolute;

        /* NEW POSITIONING: Use full height/width of the container */
        top: 0px;
        left: 0px; /* Keep left offset for text readability */
        height: 100%; /* Take full height of .text-container (400px) */
        width: 100%;

        padding: 32px;

        /* Font and sizing */
        font-size: 32px;
        color: #0091e1;

        /* Max-width enforces line wrapping, adjusted for left padding */
        max-width: calc(100% - 64px);
    }

    /* ðŸ’¡ Cursor Element Styling */
    #cursor {
        /* Set cursor appearance: a vertical bar */
        display: inline-block;
        width: 3px;
        height: 1.2em; /* Height should match font size */
        background-color: white;

        /* Position the cursor slightly lower to align with text baseline */
        vertical-align: middle;

        /* Apply the blinking animation */
        animation: blink-cursor 0.75s step-end infinite;
    }

    /* 3. Define the Animation Keyframes */

    /* Keyframes for the "cursor blink" */
    @keyframes blink-cursor {
        from,
        to {
            opacity: 0; /* Animate opacity for blinking */
        }
        50% {
            opacity: 1;
        }
    }
</style>
