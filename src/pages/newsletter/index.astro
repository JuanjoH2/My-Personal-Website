---
import NewsletterModal from "../../components/newsletterComponents/NewsletterModal.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import NewsletterCard from "../../components/newsletterComponents/NewsletterCard.astro";

const pageTitle = "Newsletter Archive";

// --- API FETCH LOGIC ---
const KIT_API_KEY = import.meta.env.V4_KIT_API_KEY;
const API_ENDPOINT = "https://api.kit.com/v4/broadcasts";
let broadcasts = [];

const url = API_ENDPOINT;
const options = {
    method: "GET",
    headers: { "X-Kit-Api-Key": KIT_API_KEY },
    body: undefined,
};

try {
    const response = await fetch(url, options);

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(
            `Kit V4 API fetch failed with status: ${response.status}. Response: ${errorText}`,
        );
    }

    const data = await response.json();

    if (data.broadcasts) {
        broadcasts = data.broadcasts
            // Filter: only include broadcasts that have a public URL and have been published
            .filter(
                (b: { public_url: any; published_at: any }) =>
                    b.public_url && b.published_at,
            )
            .map(
                (b: {
                    public_url: string | URL;
                    subject: any;
                    published_at: string | number | Date;
                }) => {
                    // Get the slug from the public_url
                    const url = new URL(b.public_url);
                    const slug = url.pathname.split("/").pop();

                    return {
                        title: b.subject,
                        // Link to the new local page
                        link: `/newsletter/${slug}`,
                        // Pass the original date for better card sorting/handling
                        date: b.published_at,
                    };
                },
            )
            // Sort by publication date, newest first (descending)
            .sort(
                (
                    a: { date: string | number | Date },
                    b: { date: string | number | Date },
                ) => new Date(b.date).getTime() - new Date(a.date).getTime(),
            );
    }
} catch (error) {
    console.error("Error fetching Kit V4 data:", error);
    broadcasts = [];
}
---

<BaseLayout pageTitle={pageTitle}>
    <NewsletterModal />

    <section class="thoughts-index">
        <div class="card-grid">
            {
                broadcasts.length > 0 ? (
                    // ðŸ’¡ Map the broadcasts to the new Card component
                    broadcasts.map(
                        (broadcast: {
                            title: string;
                            link: string;
                            date: string;
                        }) => <NewsletterCard newsletter={broadcast} />,
                    )
                ) : (
                    <p>
                        The archive is currently unavailable. Please ensure your
                        broadcasts are set to "Publish to web" and your V4 API
                        key is configured correctly in the .env file.
                    </p>
                )
            }
        </div>
    </section>
</BaseLayout>

<style>
    section {
        height: fit-content;
    }
    .thoughts-index {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    .card-grid {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 32px;
        justify-content: center;
        position: relative;
        width: 64vw;
        height: fit-content;
        padding: 32px;
    }

    /* ðŸ’¡ Global selector for the card component, assuming the card's root element is .newsletter-card-div */
    .card-grid > :global(.newsletter-card-div) {
        flex-basis: 100%;
        min-width: 200px;
        box-sizing: border-box;
    }

    /**
    * DISPLAY FOR MOBILE
    */
    @media (max-width: 500px) {
        /* One column */
        .card-grid {
            gap: 16px;
            width: 350px;
        }
        .card-grid > :global(.newsletter-card-div) {
            flex-basis: 100%;
        }
    }
</style>
