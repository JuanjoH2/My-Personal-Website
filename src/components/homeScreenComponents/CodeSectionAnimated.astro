<section id="code">
    <div id="codeDiv" class="subtitleDiv">
        <h2>Code</h2>
        <button onclick="window.location.href='/code'"> </button>
    </div>

    <!-- Container for the binary rain effect. It sits behind the code box. -->
    <div id="binaryRainContainer"></div>
</section>

<script is:inline>
    // Wait for the entire DOM to load before trying to access elements
    document.addEventListener("DOMContentLoaded", () => {
        const codeSection = document.getElementById("code");
        const container = document.getElementById("binaryRainContainer");
        const codeDiv = document.getElementById("codeDiv");
        const mobileBreakpoint = 600;

        if (!codeSection || !container || !codeDiv) {
            console.error("Required DOM elements not found for animation.");
            return;
        }

        let intervalId = null;
        const WORDS = ["1", "0"];
        const spawnRate = 50;

        function isMobileViewport() {
            // Check if the current window width is less than or equal to the defined breakpoint
            return window.innerWidth <= mobileBreakpoint;
        }

        function spawnBinaryDrop() {
            const randomIndex = Math.floor(Math.random() * WORDS.length);
            const word = WORDS[randomIndex];
            const span = document.createElement("span");
            span.className = "binary-drop";
            span.textContent = word;

            const randomXStart = Math.random() * 100;
            const fallDistanceVh = Math.random() * 50 + 100;
            const randomDuration = Math.random() * 3 + 2;
            const randomSize = Math.floor(Math.random() * 14) + 12;

            span.style.left = `${randomXStart}%`;
            span.style.fontSize = `${randomSize}px`;
            span.style.transitionDuration = `${randomDuration}s`;

            if (Math.random() < 0.1) {
                span.style.color = "#0091e1";
                span.style.opacity = "1";
            }

            container.appendChild(span);
            requestAnimationFrame(() => {
                span.style.transform = `translateY(${fallDistanceVh}vh)`;
            });

            setTimeout(
                () => {
                    span.remove();
                },
                randomDuration * 1000 + 100,
            );
        }

        function startRain() {
            if (intervalId !== null) return;
            intervalId = setInterval(spawnBinaryDrop, spawnRate);
            codeDiv.classList.add("rain-active");
        }

        function stopRain() {
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
                codeDiv.classList.remove("rain-active");
            }
        }

        // --- Core Listener Logic (Guarded by viewport check) ---

        // 1. Desktop Hover Listeners
        codeDiv.addEventListener("mouseenter", () => {
            if (!isMobileViewport()) {
                startRain();
            }
        });
        codeDiv.addEventListener("mouseleave", () => {
            if (!isMobileViewport()) {
                stopRain();
            }
        });

        // 2. Mobile Click-to-Start Listener (Only active if mobile)
        codeDiv.addEventListener("click", (event) => {
            // Check for mobile view and ensure rain is not already running
            if (isMobileViewport() && intervalId === null) {
                // Ignore if clicking the nested button
                if (event.target.tagName.toLowerCase() === "button") {
                    return;
                }
                event.stopPropagation();
                startRain();
            }
        });

        // 3. Mobile Global Stop Listener (Stops rain if click is outside codeDiv)
        document.addEventListener("click", (event) => {
            const isClickOnCodeDiv = codeDiv.contains(event.target);

            // Only act if mobile, rain is running, AND click is outside codeDiv
            if (
                isMobileViewport() &&
                intervalId !== null &&
                !isClickOnCodeDiv
            ) {
                stopRain();
            }
        });

        // --- Initialization and Cleanup ---
        stopRain();

        window.addEventListener("resize", () => {
            // Stop rain and reset when screen size changes, forcing a new interaction
            stopRain();
        });
    });
</script>

<style is:global>
    /*
     * LOCAL STYLES (is:global added to prevent Astro scoping, allowing JS-created elements to be styled)
     */
    #code {
        /* overflow: hidden is critical to hide the rain when it falls past the section boundary */
        overflow: hidden;
        position: relative;
    }

    #codeDiv {
        position: relative;
        z-index: 6;
        /* Ensure the area is responsive to touch */
        touch-action: manipulation;
    }

    #binaryRainContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* Ensure the container is behind the 'Code' box */
        z-index: 0;
        pointer-events: none; /* Allows clicks to pass through to the element behind it */
    }

    /* ðŸ’¥ HIGHLY SPECIFIC SELECTOR ðŸ’¥ */
    #binaryRainContainer .binary-drop {
        position: absolute;
        z-index: 5;

        /* CRITICAL: Start 100% of its own height UP and OFF-SCREEN. */
        transform: translateY(-100%);

        /* Base styles */
        font-weight: bold;
        white-space: nowrap;
        color: rgba(255, 255, 255, 0.6);
        opacity: 0.8;

        /* Ensure the transition property is explicitly defined */
        transition:
            transform linear,
            color 0.5s ease-out;
    }
</style>
